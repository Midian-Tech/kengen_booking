{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
{% if current_user.is_authenticated %}
<main class="col-md-10 px-3">
  <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
    <h2 class="h4 mb-2">Welcome, {{ current_user.name }}</h2>
    <a href="{{ url_for('auth.logout') }}" class="btn btn-sm btn-outline-danger">Logout</a>
  </div>

  <div class="row">

    {% if current_user.role == 'admin' %}
    <!-- Admin: Pending Approvals -->
    <div class="col-lg-4 col-md-6 mb-4">
      <div class="card text-white bg-warning h-100">
        <div class="card-header">Pending Approvals</div>
        <div class="card-body">
          {% if pending_bookings %}
            {% for booking in pending_bookings %}
              <p class="mb-1">
                <strong>{{ booking.room.name if booking.room else booking.equipment.name }}</strong><br>
                {{ booking.start_time.strftime('%Y-%m-%d %H:%M') }} to {{ booking.end_time.strftime('%H:%M') }}<br>
                <span class="badge bg-secondary">{{ booking.status }}</span>
              </p>
            {% endfor %}
          {% else %}
            <p>No pending approvals</p>
          {% endif %}
        </div>
      </div>
    </div>

    {% else %}
    <!-- Staff View -->

    <!-- Upcoming Room Bookings -->
    <div class="col-lg-6 col-md-6 mb-4">
      <div class="card text-white bg-primary h-100">
        <div class="card-header">Upcoming Room Bookings</div>
        <div class="card-body">
          {% set room_bookings = bookings
              | selectattr('room', 'ne', None)
              | selectattr('status', 'equalto', 'Approved')
              | selectattr('returned', 'equalto', False)
              | list %}
          {% if room_bookings %}
            {% for booking in room_bookings %}
              <p class="mb-1">
                <strong>{{ booking.room.name }}</strong><br>
                {{ booking.start_time.strftime('%Y-%m-%d %H:%M') }} to {{ booking.end_time.strftime('%H:%M') }}
              </p>
            {% endfor %}
          {% else %}
            <p>No upcoming room bookings</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Equipment Booking Requests (Pending or Rejected only) -->
    <div class="col-lg-6 col-md-6 mb-4">
      <div class="card text-white bg-info h-100">
        <div class="card-header">Your Equipment Booking Requests</div>
        <div class="card-body">
          {% set equipment_bookings = bookings
              | selectattr('equipment', 'ne', None)
              | selectattr('status', 'in', ['Pending', 'Rejected'])
              | list %}
          {% if equipment_bookings %}
            {% for booking in equipment_bookings %}
              <p class="mb-1">
                <strong>{{ booking.equipment.name }}</strong><br>
                {{ booking.start_time.strftime('%Y-%m-%d %H:%M') }} to {{ booking.end_time.strftime('%H:%M') }}<br>
                <span class="badge bg-{{ 'secondary' if booking.status == 'Pending' else 'danger' }}">
                  {{ booking.status }}
                </span>
              </p>
            {% endfor %}
          {% else %}
            <p>No equipment booking requests</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Room Status -->
    <div class="col-lg-4 col-md-6 mb-4">
      <div class="card text-white bg-success h-100">
        <div class="card-header">Rooms</div>
        <div class="card-body">
          {% for room in rooms %}
            <p class="mb-1">
              {{ room.name }} -
              {% if room.status %}
                <span class="badge bg-{{ 'success' if room.status.lower() == 'available' else 'secondary' }}">{{ room.status }}</span>
              {% endif %}
            </p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Equipment Status -->
    <div class="col-lg-4 col-md-6 mb-4">
      <div class="card text-white bg-dark h-100">
        <div class="card-header">Equipment Status</div>
        <div class="card-body">
          {% for item in equipment %}
            <p class="mb-1">
              {{ item.name }} -
              <span class="badge bg-{{ 'success' if item.quantity > 0 else 'danger' }}">
                {{ item.quantity }} Available
              </span>
            </p>
          {% endfor %}
        </div>
      </div>
    </div>

  </div>

  {% if current_user.role == 'admin' %}
  <!-- Analytics -->
  <div class="card shadow mb-4">
    <div class="card-header">Usage Analytics</div>
    <div class="card-body">
      <canvas id="usageChart" height="100"></canvas>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('usageChart').getContext('2d');
    const usageChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: {{ room_labels | tojson }},
        datasets: [{
          label: 'Bookings',
          data: {{ booking_counts | tojson }},
          backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1', '#0dcaf0'].slice(0, {{ booking_counts | length }})
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Most Booked Rooms' }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        }
      }
    });
  </script>
  {% endif %}
</main>

{% else %}
<div class="alert alert-warning mt-4">
  You must be logged in to view the dashboard.
</div>
{% endif %}
{% endblock %}
